<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>瑞吉外卖优化 | EastWind&amp;Blog</title><meta name="author" content="EastWind"><meta name="copyright" content="EastWind"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="瑞吉外卖的优化">
<meta property="og:type" content="article">
<meta property="og:title" content="瑞吉外卖优化">
<meta property="og:url" content="http://www.eastwind.fun/eastwind/ea7374cf.html">
<meta property="og:site_name" content="EastWind&amp;Blog">
<meta property="og:description" content="瑞吉外卖的优化">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.eastwind.fun/img/pic1.jpg">
<meta property="article:published_time" content="2023-08-12T23:18:05.929Z">
<meta property="article:modified_time" content="2023-08-14T05:55:37.151Z">
<meta property="article:author" content="EastWind">
<meta property="article:tag" content="瑞吉外卖">
<meta property="article:tag" content="实战项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.eastwind.fun/img/pic1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.eastwind.fun/eastwind/ea7374cf.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":100,"languages":{"author":"作者: EastWind","link":"链接: ","source":"来源: EastWind&Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '瑞吉外卖优化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-14 13:55:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/cat.css"><link rel="stylesheet" href="/css/rightMenu.css"><link rel="stylesheet" href="/css/Bigemails.css"><div id="myscoll"></div><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/pic3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard"><i class="fa-fw fa-solid fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/pic1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="EastWind&amp;Blog"><span class="site-name">EastWind&amp;Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard"><i class="fa-fw fa-solid fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">瑞吉外卖优化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-08-12T23:18:05.929Z" title="发表于 2023-08-13 07:18:05">2023-08-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T05:55:37.151Z" title="更新于 2023-08-14 13:55:37">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/%E7%91%9E%E5%90%89%E5%A4%96%E5%8D%96%E4%BC%98%E5%8C%96/">瑞吉外卖优化</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>50分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="瑞吉外卖优化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="缓存优化"><a href="#缓存优化" class="headerlink" title="缓存优化"></a>缓存优化</h1><h2 id="使用Git管理代码"><a href="#使用Git管理代码" class="headerlink" title="使用Git管理代码"></a>使用Git管理代码</h2><p>先让IDEA绑定<code>Github</code>，在vcs下选择创建一个git仓库，并选择需要被Git管理的目录，选择确认</p>
<p>再右击整个项目，菜单栏有个Git，依次点击命令即可</p>
<img src="https://s2.loli.net/2023/08/14/2lZQIyqfDFh75xW.png" alt="image-20230806102330765" style="zoom:50%;" />

<p>记得选中整个文件夹，不然推送可能不一定完整，commit后会出现以下情况，展示页面跟IDEA的版本有关，不过整体内容大差不差</p>
<img src="https://s2.loli.net/2023/08/14/rfy4Xt7HdEaz9Ub.png" alt="image-20230806101315050" style="zoom:50%;" />

<p>这里我们选择连Commit and Push提交带推送，这样比较快捷，但是我们还没有设置自己的远程仓库，需要去Github上复制一下自己的仓库地址来进行上传</p>
<img src="https://s2.loli.net/2023/08/14/aMI4sVzojSGxcZg.png" alt="image-20230806101640382" style="zoom:50%;" />

<p>Commit and Push后出现以下页面</p>
<img src="https://s2.loli.net/2023/08/14/AlGxPWC7wDL9u5X.png" alt="image-20230806101805774" style="zoom:50%;" />

<p>在这里定义远程仓库，把刚刚复制的仓库地址粘贴上去</p>
<img src="https://s2.loli.net/2023/08/14/K9GztY7yN5ZH8o3.png" alt="image-20230806101851407" style="zoom:50%;" />

<img src="https://s2.loli.net/2023/08/14/qAPdUYi5uhZyBVJ.png" alt="image-20230806101948608" style="zoom:50%;" />

<p>点击push推送过去，可能会让你登录一下Github进行授权啥的，这里登录就行了，然后等待推送完成，去Github上面查看一下，有就成功了<img src="https://s2.loli.net/2023/08/14/zVfioUqC5N3R8Pe.png" alt="image-20230806102219573" style="zoom:50%;" /></p>
<p>这时候我们再创建一个新的分支，把内容跟master分支分隔开</p>
<img src="https://s2.loli.net/2023/08/14/IR25xUjpYCZXb3c.png" alt="image-20230806103100562" style="zoom:50%;" />

<p>这里我创建了一个v1.0的分支</p>
<p>然后，我们把内容推送到v1.0这个分支上去</p>
<img src="https://s2.loli.net/2023/08/14/SKAhk1MtL63bERw.png" alt="image-20230806103339971" style="zoom:50%;" />

<img src="https://s2.loli.net/2023/08/14/HUmR62lZFD7zMoh.png" alt="image-20230806103356640" style="zoom:50%;" />

<p>现在的内容没有变化，是因为还没有修改代码的内容，后期在v1.0上开发，内容就不一样了</p>
<p>在v1.0上开发完成后，还可以将内容合并回master分支上，非常方便和快捷，即使写错了也不会修改原master上的代码</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="问题说明"><a href="#问题说明" class="headerlink" title="问题说明"></a>问题说明</h3><p>问题说明：</p>
<ul>
<li>当用户数量足够多的时候，系统访问量大</li>
<li>频繁的访问数据库，系统性能下降，用户体验差</li>
<li>所以一些通用、常用的数据，我们可以使用Redis来缓存，避免用户频繁访问数据库</li>
</ul>
<h3 id="导入SpringDataRedis的maven坐标"><a href="#导入SpringDataRedis的maven坐标" class="headerlink" title="导入SpringDataRedis的maven坐标"></a>导入SpringDataRedis的maven坐标</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="redis配置文件"><a href="#redis配置文件" class="headerlink" title="redis配置文件"></a>redis配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">redis:</span></span><br><span class="line">	<span class="attr">host:</span> <span class="string">localhost</span> <span class="comment">#这里换成localhost或者你自己的linux上装的redis</span></span><br><span class="line">	<span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">	<span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="配置序列化器"><a href="#配置序列化器" class="headerlink" title="配置序列化器"></a>配置序列化器</h3><ul>
<li>配置一下序列化器，防止乱码问题（实际上不是乱码，只是一种展现的形式），方便我们在图形化界面中查看我们存入的数据，在config包下新建RedisConfig类</li>
<li>但是也可以不配置RedisConfig，而是直接用<code>SpringRedisConfig</code>，它的默认序列化器就是<code>StringRedisSerializer</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> <span class="keyword">extends</span> <span class="title class_">CachingConfigurerSupport</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//默认的Key序列化器为：JdkSerializationRedisSerializer</span></span><br><span class="line">        <span class="comment">// 设置键的序列化器统一</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">// 设置值的序列化器统一</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashValueSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后将修改完的数据提交并推送到那个新的v1.0的分支上去即可</p>
<h2 id="缓存手机验证码"><a href="#缓存手机验证码" class="headerlink" title="缓存手机验证码"></a>缓存手机验证码</h2><h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p>先想一下之前做的邮件验证码是存储在哪的</p>
<p>存储在Session域中，现在学习了Redis，就可以缓存在Redis中</p>
<p>操作步骤如下：</p>
<ol>
<li>在服务端UserController中注入RedisTemplate对象，用于操作Redis；</li>
<li>在服务端UserController中的sendMsg方法中，将随机生成的验证码缓存到Redis中，并设置有效期为5分钟，因为一般的手机短信有效期也为5分钟</li>
<li>在服务端UserController中的login方法中，从Redis中获取缓存的代码，如果登录成功则删除Redis的验证码</li>
</ol>
<h3 id="代码改造"><a href="#代码改造" class="headerlink" title="代码改造"></a>代码改造</h3><p>在UserController中注入RedisTemplate对象，用于操作Redis</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br></pre></td></tr></table></figure>

<p>在服务端UserController中的sendMsg方法中，将随机生成的验证码缓存到Redis中，并设置有效期为5分钟</p>
<p>修改前后比较</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/sendMsg&quot;)</span><br><span class="line">public Result&lt;String&gt; sendMsg(@RequestBody User user, HttpSession session) throws MessagingException &#123;</span><br><span class="line">    String phone = user.getPhone();</span><br><span class="line">    if (!phone.isEmpty()) &#123;</span><br><span class="line">        //随机生成一个验证码</span><br><span class="line">        String code = MailUtils.achieveCode();</span><br><span class="line">        log.info(code);</span><br><span class="line">        //这里的phone其实就是邮箱，code是我们生成的验证码</span><br><span class="line">        MailUtils.sendTestMail(phone, code);</span><br><span class="line"><span class="deletion">-       //验证码存session，方便后面拿出来比对phone</span></span><br><span class="line"><span class="deletion">-       session.setAttribute(phone, code);</span></span><br><span class="line"><span class="addition">+		// 验证码缓存到Redis中，设置存活时间5分钟</span></span><br><span class="line"><span class="addition">+		redisTemplate.opsForValue().set(&quot;code&quot;,code,5, TimeUnit.MINUTES);</span></span><br><span class="line">        return Result.success(&quot;验证码发送成功&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return Result.error(&quot;验证码发送失败&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改后的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sendMsg&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">sendMsg</span><span class="params">(<span class="meta">@RequestBody</span> User user, HttpSession session)</span> <span class="keyword">throws</span> MessagingException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> user.getPhone();</span><br><span class="line">        <span class="keyword">if</span> (!phone.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//随机生成一个验证码</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> MailUtils.achieveCode();</span><br><span class="line">            log.info(code);</span><br><span class="line">            <span class="comment">//这里的phone其实就是邮箱，code是我们生成的验证码</span></span><br><span class="line">            MailUtils.sendTestMail(phone, code);</span><br><span class="line">            <span class="comment">// 存储到Redis中并设置5分钟的存活时间</span></span><br><span class="line">            redisTemplate.opsForValue().set(<span class="string">&quot;code&quot;</span>,code,<span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> Result.success(<span class="string">&quot;验证码发送成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="string">&quot;验证码发送失败&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在服务端UserController中的login方法中，从Redis中获取缓存的代码，如果登录成功则删除Redis的验证码</p>
<p>修改前后比较</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(&quot;/login&quot;)</span><br><span class="line">public Result&lt;User&gt; login(@RequestBody Map map, HttpSession session) &#123;</span><br><span class="line">    // 获取邮箱</span><br><span class="line">    String phone = map.get(&quot;phone&quot;).toString();</span><br><span class="line">    // 获得验证码，需要和系统内部的验证码进行比对</span><br><span class="line">    String code = map.get(&quot;code&quot;).toString();</span><br><span class="line"><span class="deletion">-   // 从session中获得验证码，session中的验证码之前在发送时，已经让服务器获得了</span></span><br><span class="line"><span class="deletion">-   String codeInSession = session.getAttribute(phone).toString();</span></span><br><span class="line"><span class="addition">+	// 把刚刚存入Redis的code拿出来</span></span><br><span class="line"><span class="addition">+   Object codeInRedis = redisTemplate.opsForValue().get(&quot;code&quot;);</span></span><br><span class="line"><span class="deletion">-   if (code != null &amp;&amp; code.equals(codeInSession)) &#123;</span></span><br><span class="line">	// 用redis中的code进行比较</span><br><span class="line"><span class="addition">+	if (code != null &amp;&amp; code.equals(codeInRedis)) &#123;</span></span><br><span class="line">        // 如果输入正确，验证用户是否存在</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; queryWrapper = new LambdaQueryWrapper&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(User::getPhone, phone);</span><br><span class="line">        User user = userService.getOne(queryWrapper);</span><br><span class="line">        if (user == null) &#123;</span><br><span class="line">            // 如果user为空，就创建一个新的user对象</span><br><span class="line">            user = new User();</span><br><span class="line">            user.setPhone(phone);</span><br><span class="line">            userService.save(user);</span><br><span class="line"><span class="deletion">-           user.setName(&quot;用户&quot; + codeInSession);</span></span><br><span class="line"><span class="addition">+			user.setName(&quot;用户&quot; + codeInRedis);</span></span><br><span class="line">        &#125;</span><br><span class="line">        // 存个session，表示登录状态</span><br><span class="line">        session.setAttribute(&quot;user&quot;, user.getId());</span><br><span class="line">        // 并作为结果返回</span><br><span class="line"><span class="addition">+       // 如果登录成功，则删除Redis中的验证码</span></span><br><span class="line"><span class="addition">+       redisTemplate.delete(&quot;code&quot;);</span></span><br><span class="line">        return Result.success(user);</span><br><span class="line">    &#125;</span><br><span class="line">    return Result.error(&quot;登录失败&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改后的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;User&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> Map map, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取邮箱</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> map.get(<span class="string">&quot;phone&quot;</span>).toString();</span><br><span class="line">    <span class="comment">// 获得验证码，需要和系统内部的验证码进行比对</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> map.get(<span class="string">&quot;code&quot;</span>).toString();</span><br><span class="line">    <span class="comment">// 把刚刚存入Redis的code拿出来</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">codeInRedis</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="comment">// 判断从Redis中获取的code是否相同</span></span><br><span class="line">    <span class="keyword">if</span> (code != <span class="literal">null</span> &amp;&amp; code.equals(codeInRedis)) &#123;</span><br><span class="line">        <span class="comment">// 如果输入正确，验证用户是否存在</span></span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(User::getPhone, phone);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.getOne(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果user为空，就创建一个新的user对象</span></span><br><span class="line">            user = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            user.setPhone(phone);</span><br><span class="line">            userService.save(user);</span><br><span class="line">            user.setName(<span class="string">&quot;用户&quot;</span> + codeInRedis);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 存个session，表示登录状态</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;user&quot;</span>, user.getId());</span><br><span class="line">        <span class="comment">// 并作为结果返回</span></span><br><span class="line">        <span class="comment">// 如果登录成功，则删除Redis中的验证码</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.success(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.error(<span class="string">&quot;登录失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h3><p>在测试时，发现一个报错：ERR Client sent AUTH, but no password is set，说是密码没有设置，原因是我们是通过redis-server.exe启动的，而双击启动默认是去找redis.conf的配置文件，然后没找到，所以也就报了之前的ERR Client sent AUTH, but no password is set错误。</p>
<p>解决办法：</p>
<p>方案1：</p>
<p>在redis安装目录下找到<strong>redis.windows.conf</strong>文件</p>
<p>找到这一行：<img src="https://s2.loli.net/2023/08/14/Xjg32vfRtr4aSQl.png" alt="image-20230806150448405" style="zoom:50%;" /></p>
<p>然后在<strong>redis目录下</strong>cmd运行命令：<code>redis-server.exe redis.windows.conf</code></p>
<p>方案2：</p>
<p><strong>其实就没设置密码，你直接把IDEA里的密码删了就行，无需密码可以直接访问</strong></p>
<p>其实是类似于之前在Linux中的vim文件里的配置</p>
<p>这里我采用的是方案2，方案1我试了几次，感觉比较麻烦，所以我采用了方案2</p>
<p>配好之后我们再次测试</p>
<p>打开redis的服务器和客户端</p>
<p>获取邮箱验证码后，在redis中进行查看</p>
<p><img src="https://s2.loli.net/2023/08/14/1cEadSMUlnQqJmC.png" alt="image-20230806153106723"></p>
<p>这里发现，redis中已经缓存了我们的数据了</p>
<p>此时我们进行登录</p>
<img src="https://s2.loli.net/2023/08/14/n4eAvH5orIf7mG8.png" alt="image-20230806153248759" style="zoom:50%;" />

<p>此时就登录成功了，我们再去看看验证码有没有被删除</p>
<p><img src="https://s2.loli.net/2023/08/14/kpPxKoXGdVNYfJB.png" alt="image-20230806153432733"></p>
<h2 id="缓存菜品数据"><a href="#缓存菜品数据" class="headerlink" title="缓存菜品数据"></a>缓存菜品数据</h2><ul>
<li>菜品数据是我们登录移动端之后的展示页面</li>
<li>所以每当我们访问首页的时候，都会调用数据库查询一遍菜品数据</li>
<li>对于这种需要频繁访问的数据，我们可以将其缓存到Redis中以减轻服务器的压力</li>
</ul>
<h3 id="实现思路-1"><a href="#实现思路-1" class="headerlink" title="实现思路"></a>实现思路</h3><ul>
<li>移动端对应的菜品查看功能，是DishController中的list方法，此方法会根据前端提交的查询条件进行数据库查询操作（用户选择不同的菜品分类）。在高并发的情况下，频繁查询数据库会导致系统性能下降，服务端响应时间增长。所以现在我们需要对此方法进行缓存优化，提高系统性能</li>
<li>但是还有存在一个问题，我们是将所有的菜品缓存一份，还是按照菜品&#x2F;套餐分类，来进行缓存数据呢？</li>
<li>答案是后者，当我们点击某一个分类时，只需展示当前分类下的菜品，而其他分类的菜品数据并不需要展示，所以我们在缓存的时候，根据菜品的分类，缓存多分类数据，页面在查询时，点击某个分类，则查询对应分类下的菜品的缓存数据</li>
<li>具体实现思路如下<ol>
<li>修改DishController中的list方法，先从Redis中获取分类对应的菜品数据，如果有，则直接返回；如果无，则查询数据库，并将查询到的菜品数据存入Redis缓存中</li>
<li>修改DishController的save、update和delete方法，加入清理缓存的逻辑，避免产生脏数据，也就是说我们修改&#x2F;更新&#x2F;删除了菜品，但是缓存没有被清理，数据还是之前的，所以展示的还是之前的，我们需要清理缓存，让它重新加载数据（其实就是我们实际已经在后台修改&#x2F;更新&#x2F;删除了某些菜品，但由于缓存数据未被清理，未重新查询数据库，用户看到的还是我们修改之前的数据）</li>
</ol>
</li>
</ul>
<h3 id="代码改造-1"><a href="#代码改造-1" class="headerlink" title="代码改造"></a>代码改造</h3><p>在DishController中需要注入<code>RedisTemplate</code>来使用Redis</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br></pre></td></tr></table></figure>

<p>修改后的代码如下</p>
<p>梳理一下思路，设立一个key用于区分不同的缓存内容，比如1号菜品里有什么菜，二号菜品有什么菜，这些缓存的key都是不同的，不能放在一个里面，通过key来进行区分，然后我们先从redis中获取对应的key，来进行判断，如果key存在，说明该缓存存在，直接返回缓存即可，否则，进行数据的查询，查询完成后，再使用redis进行数据的保存，最后返回数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="comment">// 先将返回值类型改为List&lt;DishDto&gt;</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;DishDto&gt;&gt; <span class="title function_">list</span><span class="params">(Dish dish)</span>&#123;</span><br><span class="line">        <span class="comment">// 将dishDtoList作为内容缓存到Redis中</span></span><br><span class="line">        List&lt;DishDto&gt; dishDtoList = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key是用于区分不同的缓存内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + dish.getCategoryId() + <span class="string">&quot;_&quot;</span> + dish.getStatus();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先从redis中获取缓存数据(获取的缓存数据应该是应该为dishDtoList)</span></span><br><span class="line">        dishDtoList = (List&lt;DishDto&gt;) redisTemplate.opsForValue().get(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果存在，返回数据，无需查询</span></span><br><span class="line">        <span class="keyword">if</span> (dishDtoList != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 直接将查询到的缓存数据返回</span></span><br><span class="line">            <span class="keyword">return</span> Result.success(dishDtoList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不存在，就需要进行查询，并使用redis加以缓存</span></span><br><span class="line">        <span class="comment">// 以下代码都是进行数据查询</span></span><br><span class="line"></span><br><span class="line">        LambdaQueryWrapper&lt;Dish&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 得到该菜品项对应的菜品</span></span><br><span class="line">        queryWrapper.eq(dish.getCategoryId() != <span class="literal">null</span>,Dish::getCategoryId,dish.getCategoryId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加条件，查询状态为1（起售状态）的菜品</span></span><br><span class="line">        queryWrapper.eq(Dish::getStatus,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加排序条件(先按照sort来排序，如果sort相同，再按照更新时间来排序)</span></span><br><span class="line">        queryWrapper.orderByAsc(Dish::getSort).orderByDesc(Dish::getUpdateTime);</span><br><span class="line"></span><br><span class="line">        List&lt;Dish&gt; list = dishService.list(queryWrapper);</span><br><span class="line"></span><br><span class="line">        dishDtoList = list.stream().map((item) -&gt; &#123;</span><br><span class="line">            <span class="type">DishDto</span> <span class="variable">dishDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DishDto</span>();</span><br><span class="line">            BeanUtils.copyProperties(item,dishDto);</span><br><span class="line">            <span class="comment">// 分类id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">categoryId</span> <span class="operator">=</span> item.getCategoryId();</span><br><span class="line">            <span class="comment">// 根据Id查询分类对象</span></span><br><span class="line">            <span class="type">Category</span> <span class="variable">category</span> <span class="operator">=</span> categoryService.getById(categoryId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (category != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 如果分类对象查询到了，说明该菜品有分类</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">categoryName</span> <span class="operator">=</span> category.getName();</span><br><span class="line">                <span class="comment">// 就让菜品设置一下这个分类对象名字</span></span><br><span class="line">                dishDto.setCategoryName(categoryName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 得到菜品的id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">itemId</span> <span class="operator">=</span> item.getId();</span><br><span class="line"></span><br><span class="line">            LambdaQueryWrapper&lt;DishFlavor&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// 查找与当前菜品id相同的口味信息</span></span><br><span class="line">            wrapper.eq(DishFlavor::getDishId,itemId);</span><br><span class="line">            List&lt;DishFlavor&gt; flavors = dishFlavorService.list(wrapper);</span><br><span class="line">            <span class="comment">// 设置菜品口味</span></span><br><span class="line">            dishDto.setFlavors(flavors);</span><br><span class="line">            <span class="keyword">return</span> dishDto;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将数据缓存到redis中，避免二次查询(并设置缓存时间为60分钟)</span></span><br><span class="line">        redisTemplate.opsForValue().set(key,dishDtoList,<span class="number">60</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.success(dishDtoList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>为save和update方法加入清理缓存的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> DishDto dishDto)</span> &#123;</span><br><span class="line">    dishService.saveWithFlavor(dishDto);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + dishDto.getCategoryId() + <span class="string">&quot;_1&quot;</span>;</span><br><span class="line">    <span class="comment">// 删除之前的key，也就是清除缓存，之前的内容就不存在了，会去数据库中重新查找</span></span><br><span class="line">    redisTemplate.delete(key);</span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">&quot;新增菜品成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> DishDto dishDto)</span> &#123;</span><br><span class="line">    dishService.updateWithFlavor(dishDto);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + dishDto.getCategoryId() + <span class="string">&quot;_1&quot;</span>;</span><br><span class="line">    <span class="comment">// 删除之前的key，也就是清除缓存，之前的内容就不存在了，会去数据库中重新查找</span></span><br><span class="line">    redisTemplate.delete(key);</span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">&quot;更新菜品成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我还没有写这个停售起售的功能，所以就没有进行更改，后期项目做完了再回头来补</p>
<p><strong>注意：这里并不需要我们对删除操作也进行缓存清理，因为删除操作执行之前，必须先将菜品状态修改为<code>停售</code>，而停售状态也会帮我们清理缓存，同时也看不到菜品，随后将菜品删除，仍然看不到菜品，故删除操作不需要进行缓存清理</strong></p>
<h3 id="功能测试-1"><a href="#功能测试-1" class="headerlink" title="功能测试"></a>功能测试</h3><p>在进行测试前，我们需要做一件事，就是修改RedisConfig类中之前写的值的序列化器统一，之前把他们统一成String了，所以就会只能返回String，我们去注释掉里面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> <span class="keyword">extends</span> <span class="title class_">CachingConfigurerSupport</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line"></span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//默认的Key序列化器为：JdkSerializationRedisSerializer</span></span><br><span class="line">        <span class="comment">// 设置键的序列化器统一</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">// 设置值的序列化器统一</span></span><br><span class="line"><span class="comment">//        redisTemplate.setValueSerializer(new StringRedisSerializer());</span></span><br><span class="line"><span class="comment">//        redisTemplate.setHashValueSerializer(new StringRedisSerializer());</span></span><br><span class="line">        redisTemplate.setConnectionFactory(connectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后启动测试</p>
<img src="https://s2.loli.net/2023/08/14/2N6roeYWaxXnkAf.png" alt="image-20230806210554043" style="zoom:50%;" />

<p>此时，内容就都展现出来了</p>
<p><img src="https://s2.loli.net/2023/08/14/w6rME5FiueahzJq.png" alt="image-20230806210641955"></p>
<p>并且，我们也能在redis中查询得到菜品的数据，其他内容我就不测试了，有兴趣可以自己测一下</p>
<p>最后，我们将这次写的代码push到github上</p>
<h2 id="Spring-Cache"><a href="#Spring-Cache" class="headerlink" title="Spring Cache"></a>Spring Cache</h2><h3 id="4-1Spring-Cache介绍"><a href="#4-1Spring-Cache介绍" class="headerlink" title="4.1Spring Cache介绍"></a>4.1Spring Cache介绍</h3><ul>
<li>SpringCache是一个框架，实现了基本注解的缓存功能，只需要简单的添加一个注解，就能实现缓存功能</li>
<li>SpringCache提供了一层抽象，底层可以切换不同的cache实现，具体就是通过CacheManager接口来统一不同的缓存技术</li>
<li>针对不同的缓存技术，需要实现不同的CacheManager</li>
</ul>
<table>
<thead>
<tr>
<th align="center">CacheManger</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">EhCacheCacheManager</td>
<td align="center">使用EhCache作为缓存技术</td>
</tr>
<tr>
<td align="center">GuavaCacheManager</td>
<td align="center">使用Googke的GuavaCache作为缓存技术</td>
</tr>
<tr>
<td align="center">RedisCacheManager</td>
<td align="center">使用Rdis作为缓存技术</td>
</tr>
</tbody></table>
<h3 id="SpringCache使用方式"><a href="#SpringCache使用方式" class="headerlink" title="SpringCache使用方式"></a>SpringCache使用方式</h3><p>在springboot项目中，使用缓存技术只需在项目中导入相关缓存技术的依赖包，并在启动类上使用<code>@EnableCaching</code>开启缓存支持即可</p>
<p>如果只是使用SpringCache的基础功能，只需要导入spring-boot-starter-web这个包就可以了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用Redis作为缓存技术，需要导入<code>Spring data Redis</code>的maven坐标即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>随后配置application.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span> <span class="comment">#这里换成localhost或者你自己的linux上装的redis</span></span><br><span class="line">    <span class="comment"># 这里我没有密码的原因是之前在缓存菜品数据的时候告诉我需要密码，我感觉有点麻烦就把密码去掉了</span></span><br><span class="line">    <span class="comment"># 有需要可以自己设置一下</span></span><br><span class="line">    <span class="comment"># password: 123456</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">time-to-live:</span> <span class="number">3600000</span> <span class="comment">#设置缓存存活时间为一小时，如果不设置，则一直存活</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-Cache常用注解"><a href="#Spring-Cache常用注解" class="headerlink" title="Spring Cache常用注解"></a>Spring Cache常用注解</h3><table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">@EnableCaching</td>
<td align="center">开启缓存注解功能</td>
</tr>
<tr>
<td align="center">@Cacheable</td>
<td align="center">在方法执行前spring先查看缓存中是否有数据。如果有数据，则直接返回缓存数据；若没有数据，调用方法并将方法返回值放到缓存中</td>
</tr>
<tr>
<td align="center">@CachePut</td>
<td align="center">将方法的返回值放到缓存中</td>
</tr>
<tr>
<td align="center">@CacheEvict</td>
<td align="center">将一条或者多条数据从缓存中删除</td>
</tr>
</tbody></table>
<h4 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h4><p><code>@Cacheable</code>的作用主要针对在方法执行前spring先查看缓存中是否有数据。如果有数据，则直接返回缓存数据；若没有数据，调用方法并将方法返回值放到缓存中，其主要参数说明如下</p>
<table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">说明</th>
<th align="center">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">缓存的名称，每个缓存的名称下面可以有多个Key，必须指定至少一个value</td>
<td align="center">例如:@Cacheable(value&#x3D;”mycache”)或者@Cacheable(value&#x3D;(“cache7”, “cache2”]</td>
</tr>
<tr>
<td align="center">key</td>
<td align="center">缓存的key，可以为空</td>
<td align="center">例如:@Cacheable(value&#x3D;”testcache”,key&#x3D;”#userName”)</td>
</tr>
<tr>
<td align="center">condition</td>
<td align="center">缓存的条件，可以为空，返回true或者false，只有为true 才进行缓存</td>
<td align="center">例如:@Cacheable(value&#x3D;”testcache”,condition&#x3D;”#userName.length()&gt;2”)</td>
</tr>
<tr>
<td align="center">unless</td>
<td align="center">满足条件则不缓存</td>
<td align="center">例如：@Cacheable(value &#x3D; “userCache”,key &#x3D; “#id”,unless &#x3D; “#result &#x3D;&#x3D; null”)</td>
</tr>
</tbody></table>
<h4 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h4><p><code>@CachePut</code>的作用主要针对方法配置，能够根据方法的请求参数对其结果进行缓存，将方法的返回值放入缓存</p>
<table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">说明</th>
<th align="center">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">缓存的名称，每个缓存的名称下面可以有多个Key，必须指定至少一个value</td>
<td align="center">例如:@CachePut(value &#x3D; {“userCache”,”userCacher2”}</td>
</tr>
<tr>
<td align="center">key</td>
<td align="center">缓存的key，可以为空</td>
<td align="center">例如:@CachePut(value &#x3D; {“userCache”,”userCacher2”},key &#x3D; “#user.id”)</td>
</tr>
<tr>
<td align="center">condition</td>
<td align="center">缓存的条件，可以为空，返回true或者false，只有为true 才进行缓存</td>
<td align="center">例如:@CachePut(value&#x3D;”testcache”,condition&#x3D;”#userName.length()&gt;2”</td>
</tr>
</tbody></table>
<p>这边的key可以通过里面的参数名.属性的形式来获取，使用**#参数名.属性**就可以将数据放入缓存中</p>
<p><strong>当整个方法执行完后，通过返回的值来给key赋上值，缓存的值是被返回的整个对象</strong></p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CachePut(value = &#123;&quot;userCache&quot;,&quot;userCacher2&quot;&#125;,key = &quot;#user.id&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    userService.save(user);</span><br><span class="line">    <span class="comment">// user是参数名，通过user.id就可以得到用户的id</span></span><br><span class="line">    <span class="comment">// 当整个方法执行完后，就会将key赋上值</span></span><br><span class="line">    <span class="comment">// 缓存的值是返回的整个对象，而key是自己设定的缓存key</span></span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h4><p><code>@CacheEvict</code>的作用是清除缓存</p>
<table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">说明</th>
<th align="center">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">缓存的名称，每个缓存的名称下面可以有多个Key，必须指定至少一个value</td>
<td align="center">例如:@CacheEvict(value&#x3D;”mycache”)或者@CacheEvict(value&#x3D;{“cache1”, “cache2”]</td>
</tr>
<tr>
<td align="center">key</td>
<td align="center">缓存的key，可以为空</td>
<td align="center">例如:@CacheEvict(value&#x3D;”testcache”,key&#x3D;”#userName”)</td>
</tr>
<tr>
<td align="center">condition</td>
<td align="center">缓存的条件，可以为空，返回true或者false，只有为true 才进行缓存</td>
<td align="center">例如:@CacheEvict(value&#x3D;”testcache”,condition&#x3D;”#userName.length()&gt;2”)</td>
</tr>
</tbody></table>
<p><code>@CacheEvict</code>可以清除某个缓存名称下的key缓存数据</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果key为#p1,#p2这种，代表有多参数，根据p后面的数字来决定的</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &quot;userCache&quot;,key = &quot;#p0&quot;)</span>    <span class="comment">// #p0代表第一次参数id</span></span><br><span class="line"><span class="comment">//@CacheEvict(value = &quot;userCache&quot;,key = &quot;#root.args[0]&quot;)   这个与#p1,#p2方法类似，也是参数列表</span></span><br><span class="line"><span class="comment">//@CacheEvict(value = &quot;userCache&quot;,key = &quot;#id&quot;)  通过名称获取</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>&#123;</span><br><span class="line">    userService.removeById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="缓存套餐数据"><a href="#缓存套餐数据" class="headerlink" title="缓存套餐数据"></a>缓存套餐数据</h2><p>在做套餐之前，我们可以先用注解的方式去<strong>缓存菜品数据</strong></p>
<p>先在main下开启缓存功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.ServletComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ServletComponentScan</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TakeOutApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(TakeOutApplication.class, args);</span><br><span class="line">        log.info(<span class="string">&quot;项目启动成功...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后来到DishController的list方法下进行修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@Cacheable(value=&quot;DishCache&quot;,key = &quot;#dish.getCategoryId() + &#x27;_&#x27; + #dish.getStatus()&quot;,unless = &quot;#result == null&quot;)</span></span><br><span class="line"><span class="comment">// 先将返回值类型改为List&lt;DishDto&gt;</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;DishDto&gt;&gt; <span class="title function_">list</span><span class="params">(Dish dish)</span>&#123;</span><br><span class="line">    <span class="comment">// 将dishDtoList作为内容缓存到Redis中</span></span><br><span class="line">    List&lt;DishDto&gt; dishDtoList = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不存在，就需要进行查询，并使用redis加以缓存</span></span><br><span class="line">    <span class="comment">// 以下代码都是进行数据查询</span></span><br><span class="line"></span><br><span class="line">    LambdaQueryWrapper&lt;Dish&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 得到该菜品项对应的菜品</span></span><br><span class="line">    queryWrapper.eq(dish.getCategoryId() != <span class="literal">null</span>,Dish::getCategoryId,dish.getCategoryId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加条件，查询状态为1（起售状态）的菜品</span></span><br><span class="line">    queryWrapper.eq(Dish::getStatus,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加排序条件(先按照sort来排序，如果sort相同，再按照更新时间来排序)</span></span><br><span class="line">    queryWrapper.orderByAsc(Dish::getSort).orderByDesc(Dish::getUpdateTime);</span><br><span class="line"></span><br><span class="line">    List&lt;Dish&gt; list = dishService.list(queryWrapper);</span><br><span class="line"></span><br><span class="line">    dishDtoList = list.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">DishDto</span> <span class="variable">dishDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DishDto</span>();</span><br><span class="line">        BeanUtils.copyProperties(item,dishDto);</span><br><span class="line">        <span class="comment">// 分类id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">categoryId</span> <span class="operator">=</span> item.getCategoryId();</span><br><span class="line">        <span class="comment">// 根据Id查询分类对象</span></span><br><span class="line">        <span class="type">Category</span> <span class="variable">category</span> <span class="operator">=</span> categoryService.getById(categoryId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (category != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 如果分类对象查询到了，说明该菜品有分类</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">categoryName</span> <span class="operator">=</span> category.getName();</span><br><span class="line">            <span class="comment">// 就让菜品设置一下这个分类对象名字</span></span><br><span class="line">            dishDto.setCategoryName(categoryName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到菜品的id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">itemId</span> <span class="operator">=</span> item.getId();</span><br><span class="line"></span><br><span class="line">        LambdaQueryWrapper&lt;DishFlavor&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 查找与当前菜品id相同的口味信息</span></span><br><span class="line">        wrapper.eq(DishFlavor::getDishId,itemId);</span><br><span class="line">        List&lt;DishFlavor&gt; flavors = dishFlavorService.list(wrapper);</span><br><span class="line">        <span class="comment">// 设置菜品口味</span></span><br><span class="line">        dishDto.setFlavors(flavors);</span><br><span class="line">        <span class="keyword">return</span> dishDto;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(dishDtoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在做缓存的时候报了一个错误DefaultSerializer requires a Serializable payload but received an object of type</p>
<p>解决方法：</p>
<p>为Result对象实现一个Serializable接口即可，因为Spring 会将对象先序列化再存入 Redis，所以需要实现这个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;  <span class="comment">// 编码：1成功。0和其他数字失败</span></span><br><span class="line">    <span class="keyword">private</span> String msg;  <span class="comment">// 错误信息</span></span><br><span class="line">    <span class="keyword">private</span> T data; <span class="comment">// 数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  <span class="comment">// 动态数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        Result&lt;T&gt; r = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;();</span><br><span class="line">        r.code = <span class="number">1</span>;  <span class="comment">//成功状态码</span></span><br><span class="line">        r.data = data;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">error</span><span class="params">(String errMsg)</span> &#123;</span><br><span class="line">        Result&lt;T&gt; r = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;&gt;();</span><br><span class="line">        r.msg = errMsg; <span class="comment">//设置错误信息</span></span><br><span class="line">        r.code = <span class="number">0</span>;  <span class="comment">//默认失败状态码，后期我们可以根据自己的需求来设置其他状态码</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result&lt;T&gt; <span class="title function_">add</span><span class="params">(String msg, String value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map.put(msg, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>记得删除缓存，在方法中删除缓存使用<code>@CacheEvict</code></p>
<p>save：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &quot;DishCache&quot;,key = &quot;#dishDto.getCategoryId() + &#x27;_1&#x27;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> DishDto dishDto)</span> &#123;</span><br><span class="line">    dishService.saveWithFlavor(dishDto);</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;dish_&quot;</span> + dishDto.getCategoryId() + <span class="string">&quot;_1&quot;</span>;</span><br><span class="line">    <span class="comment">// 删除之前的key，也就是清除缓存，之前的内容就不存在了，会去数据库中重新查找</span></span><br><span class="line">    redisTemplate.delete(key);</span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">&quot;新增菜品成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>update：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &quot;DishCache&quot;,key = &quot;#dishDto.getCategoryId() + &#x27;_1&#x27;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> DishDto dishDto)</span> &#123;</span><br><span class="line">    dishService.updateWithFlavor(dishDto);</span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">&quot;更新菜品成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至于为什么不给delete清缓存，在3.3功能测试有讲</p>
<p>这里我们的菜品就全部重新用注解重写了</p>
<p>再来写套餐的，写法是类似的，这里就不做说明了，直接给上代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@Cacheable(value = &quot;SetmealCache&quot;,key = &quot;#setmeal.categoryId + &#x27;_&#x27; + #setmeal.status&quot;,unless = &quot;#result == null &quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;SetmealDto&gt;&gt; <span class="title function_">list</span><span class="params">(Setmeal setmeal)</span>&#123;</span><br><span class="line">    LambdaQueryWrapper&lt;Setmeal&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 得到该套餐项对应的菜品</span></span><br><span class="line">    queryWrapper.eq(setmeal.getCategoryId() != <span class="literal">null</span>,Setmeal::getCategoryId,setmeal.getCategoryId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加条件，查询状态为1（起售状态）的菜品</span></span><br><span class="line">    queryWrapper.eq(Setmeal::getStatus,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加排序条件(按照更新时间来排序)</span></span><br><span class="line">    queryWrapper.orderByDesc(Setmeal::getUpdateTime);</span><br><span class="line"></span><br><span class="line">    List&lt;Setmeal&gt; list = setMealService.list(queryWrapper);</span><br><span class="line"></span><br><span class="line">    List&lt;SetmealDto&gt; setmealDtoList = list.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">SetmealDto</span> <span class="variable">setmealDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SetmealDto</span>();</span><br><span class="line">        BeanUtils.copyProperties(item,setmealDto);</span><br><span class="line">        <span class="comment">// 分类id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">categoryId</span> <span class="operator">=</span> item.getCategoryId();</span><br><span class="line">        <span class="comment">// 根据Id查询分类对象</span></span><br><span class="line">        <span class="type">Category</span> <span class="variable">category</span> <span class="operator">=</span> categoryService.getById(categoryId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (category != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 如果分类对象查询到了，说明该套餐有分类</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">categoryName</span> <span class="operator">=</span> category.getName();</span><br><span class="line">            <span class="comment">// 就让套餐设置一下这个分类对象名字</span></span><br><span class="line">            setmealDto.setCategoryName(categoryName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到套餐的id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">itemId</span> <span class="operator">=</span> item.getId();</span><br><span class="line"></span><br><span class="line">        LambdaQueryWrapper&lt;SetmealDish&gt; wrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 查找与当前套餐id相同的口味信息</span></span><br><span class="line">        wrapper.eq(SetmealDish::getDishId,itemId);</span><br><span class="line">        List&lt;SetmealDish&gt; flavors = setmealDishService.list(wrapper);</span><br><span class="line">        <span class="comment">// 设置菜品口味</span></span><br><span class="line">        setmealDto.setSetmealDishes(flavors);</span><br><span class="line">        <span class="keyword">return</span> setmealDto;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.success(setmealDtoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="meta">@CacheEvict(value = &quot;SetmealCache&quot;,,key = &quot;#setmealDto.categoryId + &#x27;_&#x27; + &#x27;_1&#x27;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDto setmealDto)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;套餐信息：&#123;&#125;&quot;</span>, setmealDto);</span><br><span class="line">    setMealService.saveWithDish(setmealDto);</span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">&quot;套餐添加成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>update方法也没写，哎，后期学完补上</p>
<p>将代码push到仓库里</p>
<h1 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h1><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><ul>
<li>目前我们所有的读和写的压力都是由一台数据库来承担，</li>
<li>如果数据库服务器磁盘损坏，则数据会丢失（没有备份）</li>
<li>解决这个问题，就可以用MySQL的主从复制，写操作交给主库，读操作交给从库</li>
<li>同时将主库写入的内容，同步到从库中</li>
</ul>
<img src="https://s2.loli.net/2023/08/14/B4FOw5UECuAaj3v.png" alt="image-20230807164256580" style="zoom:50%;" />

<h2 id="MySql主从复制"><a href="#MySql主从复制" class="headerlink" title="MySql主从复制"></a>MySql主从复制</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><ul>
<li>MySQL主从复制是一个异步的复制过程，底层是基于Mysql数据库自带的二进制日志功能。就是一台或多台NysQL数据库（slave，即从库）从另一台MySQL数据库(master，即主库）进行日志的复制然后再解析日志并应用到自身，最终实现从库的数据和主库的数据保持一致。<strong>MySQL主从复制是MySQL数据库自带功能，无需借助第三方工具</strong>。<ul>
<li>讲一下自己的理解，由从库(slave)向主库(master)进行日志的复制，再解析日志，解析完之后，就知道在主库里执行的是一个什么样的sql语句，然后在从库(slave)里面再执行一遍刚才得到的sql语句</li>
</ul>
</li>
<li>MySQL复制过程分成三步:<ol>
<li><code>maste</code>r将改变记录到二进制日志(<code>binary log</code>)</li>
<li><code>slave</code>将<code>master</code>的<code>binary log</code>拷贝到它的中继日志(<code>relay log</code>)</li>
<li><code>slave</code>重做中继日志中的事件，将改变应用到自己的数据库中</li>
</ol>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/08/14/gQSNBOksC8p31Hm.png" alt="image-20230807170535714"></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>前置条件<br>准备好两台服务器，分别安装MySQL并启动服务成功，这里准备两台虚拟机，建议使用克隆</p>
<p>我们先得到主库和从库的IP地址</p>
<p>进入系统，打开命令行，输入<code>ifconfig</code>查看IP地址</p>
<ul>
<li>主库IP地址：192.168.10.135</li>
<li>从库IP地址：192.168.10.134</li>
</ul>
<p>然后去mysql中连接这两个的数据库</p>
<p>如果在连接数据库时出现这样一个问题：</p>
<img src="https://s2.loli.net/2023/08/14/bCgD1wxzHYVXid9.png" alt="image-20230807175956288" style="zoom:50%;" />

<p><code>vim /etc/my.cnf</code></p>
<p>在[mysqld]后添加[<code>skip-grant-tables</code>（登录时跳过权限检查）</p>
<p><img src="https://s2.loli.net/2023/08/14/AIEKXxecfont5zR.png" alt="image-20230807180136928"></p>
<p>重启MySQL服务：<code>sudo systemctl restart mysqld</code></p>
<p>然后输入mysql就可以进去了，在里面就可以改密码干啥了，改了密码再重新连接一下就行，或者不搞密码直接搞连接也是可以的</p>
<img src="https://s2.loli.net/2023/08/14/d2mrjQvDOzRF3HM.png" alt="image-20230807180505474" style="zoom:50%;" />

<p>到数据库中连接，发现这里也可以了，我就没有设置密码，感觉设置密码比较麻烦，后面再来考虑密码的问题</p>
<p><img src="https://s2.loli.net/2023/08/14/WlLZ3OJRmUTewvN.png" alt="image-20230807180542967"></p>
<p>数据库搞好之后，我们用Xshell来连接一下自己的服务器，一个主库，一个从库</p>
<img src="https://s2.loli.net/2023/08/14/HE2wFQAKXY8Nqd3.png" alt="image-20230807181110947" style="zoom:50%;" />

<p>OK，这里连接完毕，确认一下mysql服务是否开启</p>
<img src="https://s2.loli.net/2023/08/14/V8JuQqt6SjRacTy.png" alt="image-20230807181309551" style="zoom:50%;" />

<h4 id="配置主库"><a href="#配置主库" class="headerlink" title="配置主库"></a>配置主库</h4><p>修改Mysql数据库的配置文件&#x2F;etc&#x2F;my.cnf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/08/14/artLKTpVeRMivmz.png" alt="image-20230807181738719"></p>
<p>在mysqld下加入如下内容，skip-grant-tables是我们之前加上来用于跳过权限检查的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log-bin=mysql-bin  <span class="comment">#[必须]启用二进制日志</span></span><br><span class="line">server-id=100	<span class="comment">#[必须]服务器唯一ID，值不是固定的，你只要保证唯一就行</span></span><br></pre></td></tr></table></figure>

<p>因为刚刚改了配置文件，所以我们一下重启Mysql服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<p>这时候我们再登陆Mysql数据库，执行下面的SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;eastwind&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;1234&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>在执行SQL的时候报了个异常：<code>The MySQL server is running with the --[skip-grant-tables] option so it cannot execute this statement</code></p>
<p><strong>解决方法：</strong></p>
<p>先刷新一下权限表，把在所有数据库的所有表的所有权限赋值给位于所有IP地址的root用户。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2023/08/14/u1icHWXnOPTSy6z.png" alt="image-20230807183641047"></p>
<p>再执行就没问题了</p>
<p>注：上面SQL的作用是创建一个用户eastwind，密码为1234，并且给eastwind用户授予<strong>REPLICATION SLAVE</strong>权限。常用于建立复制时所需要用到的用户权限，也就是slave必须被master授权具有该权限的用户，才能通过该用户复制。</p>
<p>接着登录Mysql数据库，执行下面的SQL，记录下结果File和Position的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> master status;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> File             <span class="operator">|</span> Position <span class="operator">|</span> Binlog_Do_DB <span class="operator">|</span> Binlog_Ignore_DB <span class="operator">|</span> Executed_Gtid_Set <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">612</span> <span class="operator">|</span>              <span class="operator">|</span>                  <span class="operator">|</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+----------+--------------+------------------+-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>注：上面的SQL的作用是查看Master的状态，执行完该SQL后不要再执行任何操作，因为我们在执行其他任何操作时，里面的日志会变化，所以不要执行其他任何操作</p>
<h4 id="配置从库"><a href="#配置从库" class="headerlink" title="配置从库"></a>配置从库</h4><p><strong>修改配置文件</strong></p>
<p>跟配置从表差不多，也是在文件里面加入一点内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server-id=101 	<span class="comment">#[必须]服务器唯一ID</span></span><br></pre></td></tr></table></figure>

<img src="https://s2.loli.net/2023/08/14/i3gBFUMCIP78yX6.png" alt="image-20230807210445457" style="zoom:50%;" />

<p>接着重启mysql服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<p>登陆Mysql数据库，执行下面的SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;192.168.10.135&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;eastwind&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;1234&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>,master_log_pos<span class="operator">=</span><span class="number">612</span>;</span><br></pre></td></tr></table></figure>

<p>简单解释一下这里的配置，master_host对应主库的ip地址，master_user对应主库的用户名，master_password对应主库的密码，master_log_file对应之前主库查出来的File，master_log_pos对应对应之前主库查出来的Position，根据自己的情况修改</p>
<p>然后执行这条SQL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p>最后执行一条SQL查看一下slave的状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> slave status\G;</span><br></pre></td></tr></table></figure>

<p>本来是<code>show slave status</code>但是显示的不太美观，所以加上\G格式化输出</p>
<img src="https://s2.loli.net/2023/08/14/gjol45GL23BrM6T.png" alt="image-20230807213311786" style="zoom:50%;" />

<p>这两个是必须是yes的，并且<code>Slave IO State</code> 什么也没有，我们发现这里其中一个是no，在翻看了文档后发现是克隆机的问题，我们需要修改克隆机的uuid，现在我们修改一下uuid</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> uuid();</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> uuid()                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> a499587b<span class="number">-3525</span><span class="number">-11</span>ee<span class="operator">-</span>b696<span class="number">-000</span>c29daa809 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>查询克隆机的uuid，并记住它</p>
<p>接着查看配置文件目录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> &quot;datadir&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> datadir       <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br></pre></td></tr></table></figure>

<p>编辑配置文件目录，修改uuid为刚刚我们生成的uuid</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /var/lib/mysql/auto.cnf</span><br></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<p>再次进入mysql查看slave的状态</p>
<img src="https://s2.loli.net/2023/08/14/Xew1gMD5LJx9c8t.png" alt="image-20230807213409815" style="zoom:50%;" />

<p>此时发现这两个都是Yes了，并且<code>Slave IO State</code>也有了对应的内容，说明我们的配置完成了</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>在主库中新建数据库，刷新一下从库</p>
<img src="https://s2.loli.net/2023/08/14/I5P9lYJn7f8WkeS.png" alt="image-20230808072609590" style="zoom:50%;" />

<p>继续在主库中进行测试，新建一张表，对表进行一下增删改操作，看看从库中是否有变化，如果有变化说明配置的没有问题，这里其他的测试我就不展示了，挺简单的</p>
<h2 id="读写分离案例"><a href="#读写分离案例" class="headerlink" title="读写分离案例"></a>读写分离案例</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>面对日益增加的系统访问量，数据库的吞吐量面临着巨大的瓶颈。对于同一时刻有<code>大量并发读操作</code>和<code>较少的写操作</code>类型的应用系统来说，将数据库拆分为<code>主库</code>和<code>从库</code>，<code>主库</code>主要负责处理事务性的<code>增删改操作</code>，从库<code>主要负责查询操作</code>，这样就能有效避免由数据更新导致的行锁，使得整个系统的查询性能得到极大的改善</p>
<img src="https://s2.loli.net/2023/08/14/doWTAXflYCszhce.png" alt="image-20230808074358625" style="zoom: 50%;" />

<h3 id="Sharding-JDBC介绍"><a href="#Sharding-JDBC介绍" class="headerlink" title="Sharding-JDBC介绍"></a>Sharding-JDBC介绍</h3><ul>
<li><p>Sharding-JDBC定位为轻量级的JAVA框架，在JAVA的JDBC层提供额外的服务，它使得客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架</p>
</li>
<li><p>使用Sharding-JDBC可以在程序中轻松的实现数据库读写分离</p>
<ul>
<li>适用于任何基于JDBC的ORM框架</li>
<li>支持任何第三方的数据库连接池</li>
<li>支持任意实现JDBC规范的数据库</li>
</ul>
</li>
<li><p>使用Sharding-JDBC框架的步骤   </p>
<ol>
<li><p>导入对应的maven坐标</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0-RC1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在配置文件中配置读写分离规则，并配置允许bean定义覆盖配置项</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="comment"># 这里的master和slave并不是写死的，但是需要跟下面的master和slave对应</span></span><br><span class="line">        <span class="comment"># 定义了两个数据源，名叫master和slave</span></span><br><span class="line">        <span class="string">master,slave</span></span><br><span class="line">      <span class="comment"># 主数据源</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="comment"># 主库ip及连接的数据库名</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.10.135:3306/reggie?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="comment"># 我的数据库没有密码，所以这里注释了，有需要可以自己调整</span></span><br><span class="line">        <span class="comment"># password: root</span></span><br><span class="line">      <span class="comment"># 从数据源</span></span><br><span class="line">      <span class="attr">slave:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="comment"># 从库ip及连接的数据库名</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.10.134:3306/reggie?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="comment"># password: root</span></span><br><span class="line">    <span class="attr">masterslave:</span></span><br><span class="line">      <span class="comment"># 读写分离配置</span></span><br><span class="line">      <span class="comment"># 负载均衡：配置的是从库的负载均衡策略(轮询策略)</span></span><br><span class="line">      <span class="comment"># 轮询：从库可以有多个，假设有3个从库，第一次走sql查询就是走1号库，第二次走2号，这样以此类		   推，直到走完之后再次重复一遍，说白了就是按顺序来</span></span><br><span class="line">      <span class="attr">load-balance-algorithm-type:</span> <span class="string">round_robin</span></span><br><span class="line">      <span class="comment"># 最终的数据源名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dataSource</span></span><br><span class="line">      <span class="comment"># 指定主库数据源名称</span></span><br><span class="line">      <span class="attr">master-data-source-name:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment"># 指定从库数据源名称列表，多个从库用逗号分隔</span></span><br><span class="line">      <span class="attr">slave-data-source-names:</span> <span class="string">slave</span></span><br><span class="line">    <span class="attr">props:</span></span><br><span class="line">      <span class="attr">sql:</span></span><br><span class="line">        <span class="attr">show:</span> <span class="literal">true</span> <span class="comment">#开启SQL显示，默认false，就是在控制台可以输出sql</span></span><br><span class="line">    <span class="comment"># 配置允许bean定义覆盖配置项</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<p>​		</p>
<h2 id="项目实现读写分离"><a href="#项目实现读写分离" class="headerlink" title="项目实现读写分离"></a>项目实现读写分离</h2><p>之前已经搭建好了主从复制的数据库，现在到主库去搭建项目的数据库</p>
<img src="https://s2.loli.net/2023/08/14/gN9tfXqWkcLYAjR.png" alt="image-20230808085658273" style="zoom:50%;" />

<p>相应的，从库里面也会创建，检查一下就行</p>
<p>然后运行一下之前的sql文件代码</p>
<img src="https://s2.loli.net/2023/08/14/YFvRWgt5LpKaf8D.png" alt="image-20230808085953402" style="zoom:50%;" />

<p>记得把这个下面这个读写分离的规则修改成改变之后的</p>
<p>导入对应的maven坐标</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0-RC1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在配置文件中配置读写分离规则，并配置允许bean定义覆盖配置项</p>
<p><strong>配置项可能会爆红，但是不影响影响项目启动，是IDEA的问题</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="comment"># 这里的master和slave并不是写死的，但是需要跟下面的master和slave对应</span></span><br><span class="line">        <span class="comment"># 定义了两个数据源，名叫master和slave</span></span><br><span class="line">        <span class="string">master,slave</span></span><br><span class="line">      <span class="comment"># 主数据源</span></span><br><span class="line">      <span class="attr">master:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="comment"># 主库ip及连接的数据库名</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.10.135:3306/reggie?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="comment"># 我的数据库没有密码，所以这里注释了，有需要可以自己调整</span></span><br><span class="line">        <span class="comment"># password: root</span></span><br><span class="line">      <span class="comment"># 从数据源</span></span><br><span class="line">      <span class="attr">slave:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="comment"># 从库ip及连接的数据库名</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.10.134:3306/reggie?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="comment"># password: root</span></span><br><span class="line">    <span class="attr">masterslave:</span></span><br><span class="line">      <span class="comment"># 读写分离配置</span></span><br><span class="line">      <span class="comment"># 负载均衡：配置的是从库的负载均衡策略(轮询策略)</span></span><br><span class="line">      <span class="comment"># 轮询：从库可以有多个，假设有3个从库，第一次走sql查询就是走1号库，第二次走2号，这样以此类		   推，直到走完之后再次重复一遍，说白了就是按顺序来</span></span><br><span class="line">      <span class="attr">load-balance-algorithm-type:</span> <span class="string">round_robin</span></span><br><span class="line">      <span class="comment"># 最终的数据源名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dataSource</span></span><br><span class="line">      <span class="comment"># 指定主库数据源名称</span></span><br><span class="line">      <span class="attr">master-data-source-name:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment"># 指定从库数据源名称列表，多个从库用逗号分隔</span></span><br><span class="line">      <span class="attr">slave-data-source-names:</span> <span class="string">slave</span></span><br><span class="line">    <span class="attr">props:</span></span><br><span class="line">      <span class="attr">sql:</span></span><br><span class="line">        <span class="attr">show:</span> <span class="literal">true</span> <span class="comment">#开启SQL显示，默认false，就是在控制台可以输出sql</span></span><br><span class="line">    <span class="comment"># 配置允许bean定义覆盖配置项</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-bean-definition-overriding:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>测试一下，主要检查的查询语句是不是由从库发出，以及增删改操作是不是由主库发出即可</p>
<p>最后我们将代码上传到github，</p>
<p>然后合并到master分支</p>
<p><strong>如何合并？</strong></p>
<p>先回到master分支，点一下master然后checkout就可以切回去了</p>
<img src="https://s2.loli.net/2023/08/14/Me9nbTHWcKy3XdA.png" alt="image-20230808093718695" style="zoom:50%;" />

<p>然后选中v1.0，选中Merge，合并到master</p>
<img src="https://s2.loli.net/2023/08/14/iXNYRvfUG9jOd1s.png" alt="image-20230808093838512" style="zoom:50%;" />

<p>查看master分支下的yml配置文件，发现已经更新了</p>
<img src="https://s2.loli.net/2023/08/14/esxmdz4VF2g75rt.png" alt="image-20230808094010705" style="zoom:50%;" />



<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>Nginx是一款轻量级的<code>Web</code>&#x2F;<code>反向代理</code>服务器以及电子邮件(IMAP&#x2F;POP3)代理服务器，其特点是占有内存少，并发能力强。</li>
<li>事实上Nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用Nginx的网站有：百度、京东、新浪、网易、腾讯、淘宝等。</li>
<li>Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点（俄文：Pam6nep）开发的，第一个公开版本0.1.0发布于2004年10月4日。</li>
<li>官网：<code>https://nginx.org/</code></li>
</ul>
<h2 id="Nginx的下载和安装"><a href="#Nginx的下载和安装" class="headerlink" title="Nginx的下载和安装"></a>Nginx的下载和安装</h2><p>Nginx是C语言开发的，所以需要先安装依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc pcre-devel zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>安装时遇到一个问题：Another app is currently holding the yum lock; waiting for it to exit…</p>
<p>说是<strong>另一个应用程序目前持有yum锁；等待它退出</strong></p>
<p>解决方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强行解除锁定</span></span><br><span class="line"><span class="built_in">rm</span> -rf /var/run/yum.pid </span><br><span class="line"><span class="comment"># 再次yum安装</span></span><br></pre></td></tr></table></figure>

<p>下载Nginx安装包</p>
<p>这里我去了nginx官网查看了现在的稳定版本，现在是1.24.0所以我也选择1.24.0</p>
<img src="https://s2.loli.net/2023/08/14/lW8ANYxayt74KdR.png" alt="image-20230808100050448" style="zoom:50%;" />

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://nginx.org/download/nginx-1.24.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>可以使用命令行方式，你也可以通过在Windows下载好之后传上来，我是直接上传了</p>
<p>解压，放在<code>/usr/local</code>目录下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.24.0.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>

<p>进入到我们解压完毕后的文件夹内</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/nginx-nginx-1.24.0/</span><br></pre></td></tr></table></figure>

<p>创建安装路径文件夹 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /usr/local/nginx</span><br></pre></td></tr></table></figure>

<p>安装前检查工作</p>
<p>使用nginx-nginx-1.24.0目录下的configure来指定安装目录（不是真正的安装，只是安装前的检查工作）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx</span><br></pre></td></tr></table></figure>

<p>编译并安装 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="Nginx目录结构"><a href="#Nginx目录结构" class="headerlink" title="Nginx目录结构"></a>Nginx目录结构</h2><ul>
<li>安装完Nginx后，我们先来熟悉一下Nginx的目录结构</li>
<li>重点目录&#x2F;文件:<ul>
<li>conf<ul>
<li>nginx配置文件</li>
<li>操作较多的是里面的nginx.conf</li>
</ul>
</li>
<li>html<ul>
<li>存放静态文件(html、css、Js等)</li>
</ul>
</li>
<li>logs  <ul>
<li>日志目录，存放日志文件</li>
</ul>
</li>
<li>sbin&#x2F;nginx  <ul>
<li>二进制文件，用于启动、停止Nginx服务</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>可以使用一个命令来展示当前目录下的内容</p>
<p>先安装这个tree</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install tree	</span><br></pre></td></tr></table></figure>

<p>再输入<code>tree</code></p>
<p>以树形结构来展示当前目录下的所有内容</p>
<img src="https://s2.loli.net/2023/08/14/ofRHVWZwyiEz3mN.png" alt="image-20230808103138800" style="zoom:50%;" />

<h2 id="Nginx配置文件结构"><a href="#Nginx配置文件结构" class="headerlink" title="Nginx配置文件结构"></a>Nginx配置文件结构</h2><ul>
<li>Nginx配置文件(conf&#x2F;nginx.conf)整体分为三部分<ul>
<li><strong>全局块</strong>  和Nginx运行相关的全局配置</li>
<li><strong>events块</strong>  和网络连接相关的配置</li>
<li><strong>http块</strong>    代理、缓存、日志记录、虚拟主机配置<ul>
<li>http全局块</li>
<li><strong>Server块</strong><ul>
<li>Server全局块</li>
<li>location块</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注意：http块中可以配置多个Server块，每个Server块中可以配置多个location块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1;                             &lt;-- 全局块</span><br><span class="line">  </span><br><span class="line">events &#123;                                          &lt;-- events块</span><br><span class="line">    worker_connections  1024;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">http &#123;                                            &lt;-- http块</span><br><span class="line">    include       mime.types;                     &lt;-- http全局块</span><br><span class="line">    default_type  application/octet-stream;  </span><br><span class="line">    sendfile        on;  </span><br><span class="line">    keepalive_timeout  65;  </span><br><span class="line">  </span><br><span class="line">    server &#123;                                      &lt;-- Server块</span><br><span class="line">        listen       80;                          &lt;-- Server全局块</span><br><span class="line">        server_name  localhost;  </span><br><span class="line">        location / &#123;                              &lt;-- location块</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx命令"><a href="#Nginx命令" class="headerlink" title="Nginx命令"></a>Nginx命令</h2><h3 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h3><ul>
<li>进入sbin目录，输入<code>./nginx -v</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># ./nginx -v</span></span><br><span class="line">nginx version: nginx/1.24.0</span><br></pre></td></tr></table></figure>

<h3 id="检查配置文件正确性"><a href="#检查配置文件正确性" class="headerlink" title="检查配置文件正确性"></a>检查配置文件正确性</h3><p>进入sbin目录，输入<code>./nginx -t</code>，如果有错误会报错，而且也会记录日志</p>
<p>一般在启动Nginx服务之前检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># ./nginx -t</span></span><br><span class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure>

<h3 id="启动和停止"><a href="#启动和停止" class="headerlink" title="启动和停止"></a>启动和停止</h3><p>进入sbin目录，输入<code>./nginx</code>，启动完成后查看进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># ./nginx </span></span><br><span class="line">[root@localhost sbin]<span class="comment"># ps -ef | grep nginx</span></span><br><span class="line">root      13485      1  0 19:36 ?        00:00:00 nginx: master process ./nginx</span><br><span class="line">nobody    13486  13485  0 19:36 ?        00:00:00 nginx: worker process</span><br><span class="line">root      13496   9863  0 19:36 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>如果想停止Nginx服务，输入<code>./nginx -s stop</code>，停止服务后再次查看进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sbin]<span class="comment"># ./nginx -s stop</span></span><br><span class="line">[root@localhost sbin]<span class="comment"># ps -ef | grep nginx</span></span><br><span class="line">root      13499   9863  0 19:37 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<h3 id="重新加载配置文件"><a href="#重新加载配置文件" class="headerlink" title="重新加载配置文件"></a>重新加载配置文件</h3><p>重新加载配置文件</p>
<ul>
<li>当修改Nginx配置文件后，需要重新加载才能生效，可以使用下面命令重新加载配置文件：<code>./nginx -s reload</code></li>
</ul>
<p>上面的所有命令，都需要我们在sbin目录下才能运行，比较麻烦，所以我们可以将Nginx的二进制文件配置到环境变量中，这样无论我们在哪个目录下，都能使用上面的命令</p>
<p>使用<code>vim /etc/profile</code>命令打开配置文件，并配置环境变量，保存并退出</p>
<p>这个需要配置jdk的环境，记得改成自己的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=/usr/local/jdk1.8.0_212</span><br><span class="line">PATH=/usr/local/nginx/sbin:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>之后重新加载配置文件，使用<code>source /etc/profile</code>命令，然后我们在任意位置输入<code>nginx</code>即可启动服务，<code>nginx -s stop</code>即可停止服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost jdk1.8.0_212]<span class="comment"># vim /etc/profile</span></span><br><span class="line">[root@localhost jdk1.8.0_212]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root@localhost jdk1.8.0_212]<span class="comment"># nginx</span></span><br><span class="line">[root@localhost jdk1.8.0_212]<span class="comment"># ps -ef | grep nginx</span></span><br><span class="line">root      13942      1  0 19:51 ?        00:00:00 nginx: master process nginx</span><br><span class="line">nobody    13943  13942  0 19:51 ?        00:00:00 nginx: worker process</span><br><span class="line">root      13945   9863  0 19:51 pts/1    00:00:00 grep --color=auto nginx</span><br><span class="line">[root@localhost jdk1.8.0_212]<span class="comment"># nginx -s stop</span></span><br><span class="line">[root@localhost jdk1.8.0_212]<span class="comment"># ps -ef | grep nginx</span></span><br><span class="line">root      13956   9863  0 19:52 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<p>查看自己IP，启动服务后，浏览器输入ip地址就可以访问Nginx的默认页面</p>
<ul>
<li><code>ifconfig</code></li>
</ul>
<p>如果发现自己连不上Nginx的话，可能是防火墙的问题，这里我也遇到了这个问题，所以我们需要开放80端口，并重启防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart firewalld.service</span><br></pre></td></tr></table></figure>

<p>重启完成后，在浏览器中输入ip即可访问</p>
<img src="https://s2.loli.net/2023/08/14/SnKIjP36WoecsRH.png" alt="image-20230808111005173" style="zoom:50%;" />

<h2 id="Nginux具体应用"><a href="#Nginux具体应用" class="headerlink" title="Nginux具体应用"></a>Nginux具体应用</h2><h3 id="部署静态资源"><a href="#部署静态资源" class="headerlink" title="部署静态资源"></a>部署静态资源</h3><ul>
<li>Nginx可以作为静态web服务器来部署静态资源。静态资源指在服务端真实存在并且能够直接展示的一些文件，比如常见的html页面、css文件、js文件、图片、视频等资源。</li>
<li>相对于Tomcat，Nginx处理静态资源的能力更加高效，所以在生产环境下，一般都会将静态资源部署到Nginx中。</li>
<li>将静态资源部署到Nginx非常简单，只需要将文件复制到Nginx安装目录下的html目录中即可。</li>
</ul>
<img src="https://s2.loli.net/2023/08/14/CYDpmozBg2Kq3ib.png" alt="image-20230808134539268" style="zoom:50%;" />

<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p><strong>正向代理</strong></p>
<ul>
<li>正向代理是一个位于客户端和原始服务器（origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标（原始服务器），然后代理向原始服务器转交请求并将获得的内容返回给客户端。</li>
<li>正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。</li>
<li>正向代理一般是在客户端设置代理服务器，通过代理服务器转发请求，最终访问到目标服务器。</li>
</ul>
<img src="https://s2.loli.net/2023/08/14/zC65PldVj1ry7Lk.png" alt="image-20230808134722027" style="zoom:50%;" />

<p>总结一下正向代理，其实很好理解，客户端直接访问原始服务器是访问不到的，得依靠代理服务器来访问，所以客户端需要先向代理服务器发送请求来指定原始服务器，然后代理服务器向原始服务器转交请求，原始服务器将内容发给代理服务器，再依靠代理服务器来返回给客户端</p>
<p><strong>反向代理</strong></p>
<ul>
<li>反向代理服务器位于用户与目标服务器之间，但是对于用户而言，反向代理服务器就相当于目标服务器，即用户直接访问反向代理服务器就可以获得目标服务器的资源，反向代理服务器负责将请求转发给目标服务器。</li>
<li>用户不需要知道目标服务器的地址，也无须在用户端作任何设定。</li>
</ul>
<img src="https://s2.loli.net/2023/08/14/3riCkwhIoZmDYqz.png" alt="image-20230808134745099" style="zoom:67%;" />

<p>简单来说，正向代理是:(客户端+代理服务器)访问(web服务器)，，  反向代理是：(客户端)访问(代理服务器+web服务器)</p>
<p>反向代理直接访问的是代理服务器，然后让代理服务器去web服务器里转发给你</p>
<h4 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">82;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="comment">    	# 监听82端口，访问82端口则代理转发到下面的地址</span></span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://IP地址:端口号;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul>
<li>早期的网站流量和业务功能都比较简单，单台服务器就可以满足基本需求，但是随着互联网的发展，业务流量越来越大并且业务逻辑也越来越复杂，单台服务器的性能及单点故障问题就凸显出来了，因此需要多台服务器组成应用集群，进行性能的水平扩展以及避免单点故障出现。</li>
<li>应用集群：将同一应用部署到多台机器上，组成应用集群，接收负载均衡器分发的请求，进行业务处理并返回响应数据。</li>
<li>负载均衡器：将用户请求根据对应的负载均衡算法分发到应用集群中的一台服务器进行处理。</li>
</ul>
<img src="https://s2.loli.net/2023/08/14/SWdngvQqLhOjAEw.png" alt="image-20230808140916732" style="zoom:67%;" />

<p>配置负载均衡<br>默认是轮询算法，第一次访问是<code>IP地址1</code>，第二次访问是<code>IP地址2</code><br>也可以改用权重方式，权重越大，几率越大，现在的访问三分之二是第一台服务器接收，三分之一是第二台服务器接收<br><code>server IP地址1 weight=10</code><br><code>server IP地址2 weight=5</code></p>
<p>proxy_pass要与targetServer一致</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">targetServer&#123;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">IP地址1:端口号;</span></span><br><span class="line">    <span class="attr">server</span> <span class="string">IP地址2:端口号;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span>       <span class="string">82;</span></span><br><span class="line">    <span class="attr">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://targetServer;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>负载均衡策略</li>
</ul>
<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">轮询</td>
<td align="center">默认方式</td>
</tr>
<tr>
<td align="center">weight</td>
<td align="center">权重方式</td>
</tr>
<tr>
<td align="center">ip_hash</td>
<td align="center">依据ip分配方式</td>
</tr>
<tr>
<td align="center">least_conn</td>
<td align="center">依据最少连接方式</td>
</tr>
<tr>
<td align="center">url_hash</td>
<td align="center">依据url分配方式</td>
</tr>
<tr>
<td align="center">fair</td>
<td align="center">依据响应时间方式</td>
</tr>
</tbody></table>
<h2 id="Nginx的特点"><a href="#Nginx的特点" class="headerlink" title="Nginx的特点"></a>Nginx的特点</h2><ol>
<li>跨平台：Nginx可以在大多数操作系统中运行，而且也有Windows的移植版本</li>
<li>配置异常简单：非常容易上手。配置风格跟程序开发一样，神一般的配置</li>
<li>非阻塞、高并发：数据复制时，磁盘I&#x2F;O的第一阶段是非阻塞的。官方测试能够支撑5万并发连接，在实际生产环境中跑到2-3万并发连接数（这得益于Nginx使用了最新的epoll模型）</li>
<li>事件驱动：通信机制采用epoll模式，支持更大的并发连接数</li>
<li>内存消耗小：处理大并发的请求内存消耗非常小。在3万并发连接下，开启的10个Nginx进程才消耗150M内存（15M*10&#x3D;150M）</li>
<li>成本低廉：Nginx作为开源软件，可以免费试用。而购买F5 BIG-IP、NetScaler等硬件负载均衡交换机则需要十多万至几十万人民币</li>
<li>内置健康检查功能：如果Nginx Proxy后端的某台Web服务器宕机了，不会影响前端访问。</li>
<li>节省带宽：支持GZIP压缩，可以添加浏览器本地缓存的Header头。</li>
<li>稳定性高：用于反向代理，宕机的概率微乎其微。</li>
</ol>
<h1 id="前后端分离开发"><a href="#前后端分离开发" class="headerlink" title="前后端分离开发"></a>前后端分离开发</h1><h2 id="问题说明-1"><a href="#问题说明-1" class="headerlink" title="问题说明"></a>问题说明</h2><ul>
<li>开发人员同时负责前端和后端代码开发，分工不明确，开发效率低</li>
<li>前后端代码混合在一个工程中，不便于管理</li>
<li>对开发人员要求高，人员招聘困难</li>
<li>所以衍生出了一种前后端分离开发</li>
</ul>
<h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><ul>
<li><code>前后端分离开发</code>，就是在项目开发过程中，对前端代码的开发，专门由<code>前端开发人员</code>负责，后端代码由<code>后端开发人员</code>负责，这样可以做到分工明确，各司其职，提高开发效率，前后端代码并行开发，可以加快项目的开发速度。目前，前后端分离开发方式已经被越来越多的公司采用了，成为现在项目开发的主流开发方式。</li>
<li>前后端分离开发后，从工程结构上也会发生变化，即前后端代码不再混合在同一个maven工程中，而是分为<code>前端工程和后端工程</code></li>
</ul>
<img src="https://s2.loli.net/2023/08/14/D9Qy2bpzGJ3HMEK.png" alt="image-20230808150333666" style="zoom:50%;" />

<h2 id="开发流程"><a href="#开发流程" class="headerlink" title="开发流程"></a>开发流程</h2><ul>
<li>前后端开发人员都参照接口API文档进行开发</li>
<li>接口（API接口） 就是一个http的请求地址，主要就是去定义：请求路径、请求方式、请求参数、响应参数等内容。</li>
</ul>
<img src="https://s2.loli.net/2023/08/14/uZl4fXd8PMg69eD.png" alt="image-20230808150400991" style="zoom:67%;" />

<h2 id="YApi"><a href="#YApi" class="headerlink" title="YApi"></a>YApi</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>Api是高效、易用、功能强大的api管理平台，旨在为开发、产品、测试人员提供更优雅的接口管理服务。可以帮助开发者轻松创建、发布、维护API，YApi还为用户提供了优秀的交互体验，开发人员只需要利用平台提供的接口数据写入工具以及简单的点击操作就可以实现接口的管理。</p>
<p>YApi让接口开发更简单高效，让接口的管理更具有可读性、可维护性，让团队协作更合理。</p>
<p>Git仓库：<code>https://github.com/YMFE/yapi</code></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>使用YApi，可以执行下面操作：</p>
<ul>
<li>添加项目</li>
<li>添加分类</li>
<li>添加接口</li>
<li>编辑接口</li>
<li>查看接口</li>
</ul>
<p>这个后期看看文档自学一下即可</p>
<h2 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h2><h3 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h3><ul>
<li>使用Swagger你只需要按照它的规范去定义接口及接口相关的信息，再通过Swagger衍生出来的一系列项目和工具，就可以做成各种格式的接口文档，以及在线接口调试页面等。</li>
<li>官网：<code>https://swagger.io/</code></li>
</ul>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><ol>
<li>导入对应的maven坐标</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>导入knife4j相关配置，并配置静态资源映射，否则接口文档页面无法访问，注意将controller的包路径修改为你自己的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="meta">@EnableKnife4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始进行静态资源映射...&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/backend/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/backend/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/front/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/front/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;doc.html&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/&quot;</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/webjars/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">messageConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line">        <span class="comment">//设置对象转化器，底层使用jackson将java对象转为json</span></span><br><span class="line">        messageConverter.setObjectMapper(<span class="keyword">new</span> <span class="title class_">JacksonObjectMapper</span>());</span><br><span class="line">        <span class="comment">//将上面的消息转换器对象追加到mvc框架的转换器集合当中(index设置为0，表示设置在第一个位置，避免被其它转换器接收，从而达不到想要的功能)</span></span><br><span class="line">        converters.add(<span class="number">0</span>, messageConverter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//文档类型</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.eastwind.controller&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;瑞吉外卖&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;瑞吉外卖接口文档&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在拦截器在中设置不需要处理的请求路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义不需要处理的请求</span></span><br><span class="line">String[] urls = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">        <span class="string">&quot;/employee/login&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/employee/logout&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/backend/**&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/front/**&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/common/**&quot;</span>,</span><br><span class="line">        <span class="comment">//对用户登陆操作放行</span></span><br><span class="line">        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/user/sendMsg&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;/doc.html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/webjars/**&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/swagger-resources&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/v2/api-docs&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>启动服务，访问 <code>http://localhost/doc.html</code> ，我这里的端口号用的80，根据自己的需求改，运行之前记得把linux的服务开起来</p>
<p>这里我启动时报了一个异常，</p>
<p><strong>Failed to start bean ‘documentationPluginsBootstrapper’; nested exception is java.lang.NullPointerException</strong></p>
<p>springboot 升级到 2.6.0之后，swagger版本和springboot出现了不兼容情况，因为SpringBoot处理映射匹配的默认策略发生变化：请求路径与 Spring MVC 处理映射匹配的默认策略已从AntPathMatcher更改为PathPatternParser</p>
<p>在application.yml中配置，加在spring的下面，注意层级关系</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mvc:</span></span><br><span class="line">	<span class="attr">pathmatch:</span></span><br><span class="line">		<span class="attr">matching-strategy:</span> <span class="string">ant_path_matcher</span></span><br></pre></td></tr></table></figure>

<p>访问接口文档<img src="https://s2.loli.net/2023/08/14/LtaATEVNFR9hBxm.png" alt="image-20230808155517784" style="zoom:50%;" /></p>
<p>此时就显示出来了</p>
<h3 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h3><table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">@Api</td>
<td align="center">用在请求的类上，例如Controller，表示对类的说明</td>
</tr>
<tr>
<td align="center">@ApiModel</td>
<td align="center">用在类上，通常是个实体类，表示一个返回响应数据的信息</td>
</tr>
<tr>
<td align="center">@ApiModelProperty</td>
<td align="center">用在属性上，描述响应类的属性</td>
</tr>
<tr>
<td align="center">@ApiOperation</td>
<td align="center">用在请求的方法上，说明方法的用途、作用</td>
</tr>
<tr>
<td align="center">@ApilmplicitParams</td>
<td align="center">用在请求的方法上，表示一组参数说明</td>
</tr>
<tr>
<td align="center">@ApilmplicitParam</td>
<td align="center">用在@ApilmplicitParams注解中，指定一个请求参数的各个方面</td>
</tr>
</tbody></table>
<p>加上这些注解，可以将我们生成的接口文档更规范，具体使用效果可以看看文档，这里不做太多介绍</p>
<h1 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h1><h2 id="配置环境说明"><a href="#配置环境说明" class="headerlink" title="配置环境说明"></a>配置环境说明</h2><p>一共需要三台服务器</p>
<ul>
<li>192.168.10.135（服务器A）<ul>
<li>Nginx：部署前端项目、配置反向代理</li>
<li>MySql：主从复制结构中的主库</li>
</ul>
</li>
<li>192.168.10.134（服务器B）<ul>
<li>jdk：运行java项目</li>
<li>git：版本控制工具</li>
<li>maven：项目构建工具</li>
<li>jar：Spring Boot 项目打成jar包基于内置Tomcat运行</li>
<li>MySql：主从复制结构中的从库</li>
</ul>
</li>
<li>IP地址（服务器C）<ul>
<li>Redis：缓存中间件</li>
</ul>
</li>
</ul>
<p>在服务器A中安装Nginx，将前端项目<code>打包</code>目录上传到Nginx的html目录下</p>
<p>修改Nginx配置文件nginx.conf，新增如下配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line">    <span class="attr">server_name</span> <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">        <span class="attr">root</span> <span class="string">html/dist;</span></span><br><span class="line">        <span class="attr">index</span> <span class="string">index.html;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">location</span> <span class="string">^~ /api/ &#123;</span></span><br><span class="line">        <span class="attr">rewrite</span> <span class="string">^/api/(.*)$ /$1 break;</span></span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://192.168.10.134;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>在服务器B中安装JDK，Git，MySql</p>
<p>将项目打成jar包，手动上传并部署（当然你也可以选择git拉取代码，然后shell脚本自动部署）</p>
<p>部署完后端项目之后，我们就能完成正常的登录功能了，也能进入到后台系统进行增删改查操作</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://www.eastwind.fun">EastWind</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://www.eastwind.fun/eastwind/ea7374cf.html">http://www.eastwind.fun/eastwind/ea7374cf.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.eastwind.fun" target="_blank">EastWind&Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%91%9E%E5%90%89%E5%A4%96%E5%8D%96/">瑞吉外卖</a><a class="post-meta__tags" href="/tags/%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/">实战项目</a></div><div class="post_share"><div class="social-share" data-image="/img/pic1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechatpay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechatpay.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/eastwind/a1e1aa91.html" title="瑞吉外卖"><img class="cover" src="/img/pic7.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">瑞吉外卖</div></div></a></div><div class="next-post pull-right"><a href="/eastwind/f3404829.html" title="碎碎念"><img class="cover" src="/img/pic1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">碎碎念</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/eastwind/a1e1aa91.html" title="瑞吉外卖"><img class="cover" src="/img/pic7.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-13</div><div class="title">瑞吉外卖</div></div></a></div><div><a href="/eastwind/a97adaa0.html" title="Git工具"><img class="cover" src="/img/pic7.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-13</div><div class="title">Git工具</div></div></a></div><div><a href="/eastwind/6a343b7f.html" title="Redis入门"><img class="cover" src="/img/pic5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-13</div><div class="title">Redis入门</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/pic3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">EastWind</div><div class="author-info__description">东风但丁的博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/WindyDante"><i class="fab fa-github"></i><span>卑微求关注</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/WindyDante" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">博客日常更新中<img src="https://cdn.jsdelivr.net/gh/lete114/CDN/Use/my_bg.gif"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">缓存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Git%E7%AE%A1%E7%90%86%E4%BB%A3%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">使用Git管理代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.1.</span> <span class="toc-text">问题说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5SpringDataRedis%E7%9A%84maven%E5%9D%90%E6%A0%87"><span class="toc-number">1.2.2.</span> <span class="toc-text">导入SpringDataRedis的maven坐标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.3.</span> <span class="toc-text">redis配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">配置序列化器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%89%8B%E6%9C%BA%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">1.3.</span> <span class="toc-text">缓存手机验证码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.1.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%94%B9%E9%80%A0"><span class="toc-number">1.3.2.</span> <span class="toc-text">代码改造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">功能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.</span> <span class="toc-text">缓存菜品数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%94%B9%E9%80%A0-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">代码改造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95-1"><span class="toc-number">1.4.3.</span> <span class="toc-text">功能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cache"><span class="toc-number">1.5.</span> <span class="toc-text">Spring Cache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1Spring-Cache%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1Spring Cache介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringCache%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">SpringCache使用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Cache%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.5.3.</span> <span class="toc-text">Spring Cache常用注解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cacheable"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">@Cacheable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CachePut"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">@CachePut</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CacheEvict"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">@CacheEvict</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%A5%97%E9%A4%90%E6%95%B0%E6%8D%AE"><span class="toc-number">1.6.</span> <span class="toc-text">缓存套餐数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">2.</span> <span class="toc-text">读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">2.2.</span> <span class="toc-text">MySql主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.2.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E5%BA%93"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">配置主库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%8E%E5%BA%93"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">配置从库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%A1%88%E4%BE%8B"><span class="toc-number">2.3.</span> <span class="toc-text">读写分离案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">2.3.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sharding-JDBC%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.3.2.</span> <span class="toc-text">Sharding-JDBC介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">2.4.</span> <span class="toc-text">项目实现读写分离</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx"><span class="toc-number">3.</span> <span class="toc-text">Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.</span> <span class="toc-text">Nginx的下载和安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">3.3.</span> <span class="toc-text">Nginx目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-number">3.4.</span> <span class="toc-text">Nginx配置文件结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%91%BD%E4%BB%A4"><span class="toc-number">3.5.</span> <span class="toc-text">Nginx命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC"><span class="toc-number">3.5.1.</span> <span class="toc-text">查看版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%AD%A3%E7%A1%AE%E6%80%A7"><span class="toc-number">3.5.2.</span> <span class="toc-text">检查配置文件正确性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%92%8C%E5%81%9C%E6%AD%A2"><span class="toc-number">3.5.3.</span> <span class="toc-text">启动和停止</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.4.</span> <span class="toc-text">重新加载配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginux%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8"><span class="toc-number">3.6.</span> <span class="toc-text">Nginux具体应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-number">3.6.1.</span> <span class="toc-text">部署静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">3.6.2.</span> <span class="toc-text">反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">配置反向代理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">3.6.3.</span> <span class="toc-text">负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">3.7.</span> <span class="toc-text">Nginx的特点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91"><span class="toc-number">4.</span> <span class="toc-text">前后端分离开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AF%B4%E6%98%8E-1"><span class="toc-number">4.1.</span> <span class="toc-text">问题说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">4.2.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">4.3.</span> <span class="toc-text">开发流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YApi"><span class="toc-number">4.4.</span> <span class="toc-text">YApi</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">4.4.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">4.4.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Swagger"><span class="toc-number">4.5.</span> <span class="toc-text">Swagger</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">4.5.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">4.5.2.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">4.5.3.</span> <span class="toc-text">常用注解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="toc-number">5.1.</span> <span class="toc-text">配置环境说明</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/eastwind/f3404829.html" title="碎碎念"><img src="/img/pic1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="碎碎念"/></a><div class="content"><a class="title" href="/eastwind/f3404829.html" title="碎碎念">碎碎念</a><time datetime="2023-08-12T23:18:05.930Z" title="发表于 2023-08-13 07:18:05">2023-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/eastwind/ea7374cf.html" title="瑞吉外卖优化"><img src="/img/pic1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖优化"/></a><div class="content"><a class="title" href="/eastwind/ea7374cf.html" title="瑞吉外卖优化">瑞吉外卖优化</a><time datetime="2023-08-12T23:18:05.929Z" title="发表于 2023-08-13 07:18:05">2023-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/eastwind/a1e1aa91.html" title="瑞吉外卖"><img src="/img/pic7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖"/></a><div class="content"><a class="title" href="/eastwind/a1e1aa91.html" title="瑞吉外卖">瑞吉外卖</a><time datetime="2023-08-12T23:18:05.928Z" title="发表于 2023-08-13 07:18:05">2023-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/eastwind/6a343b7f.html" title="Redis入门"><img src="/img/pic5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis入门"/></a><div class="content"><a class="title" href="/eastwind/6a343b7f.html" title="Redis入门">Redis入门</a><time datetime="2023-08-12T23:18:05.926Z" title="发表于 2023-08-13 07:18:05">2023-08-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/eastwind/a97adaa0.html" title="Git工具"><img src="/img/pic7.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Git工具"/></a><div class="content"><a class="title" href="/eastwind/a97adaa0.html" title="Git工具">Git工具</a><time datetime="2023-08-12T23:18:05.925Z" title="发表于 2023-08-13 07:18:05">2023-08-13</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/pic1.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> EastWind</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ ">&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a></p></div></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-home"><i class="fa-solid fa-house"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuNormal"><div class="rightMenu-item" id="menu-translate"><i class="fa-solid fa-earth-asia"></i><span>繁简切换</span></div><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-moon"></i><span>切换模式</span></div></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://love-twikoo.eastwind.fun/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://love-twikoo.eastwind.fun/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      GLOBAL_CONFIG_SITE.isPost && getCount()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><div class="aplayer no-destroy" data-id="7427714271" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="true" muted></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script data-pjax defer src="https://npm.elemecdn.com/tzy-blog/lib/js/theme/chocolate.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/rightMenu.js"></script><script defer data-pjax src="/js/Bigemails.js"></script><script defer data-pjax src="/js/cat.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script>(() => {
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "7d87d34f-33be-4b63-97dd-231a28ea9e5e";
  (function () {
    d = document;
    s = d.createElement("script");
    s.src = "https://client.crisp.chat/l.js";
    s.async = 1;
    d.getElementsByTagName("head")[0].appendChild(s);
  })();
  $crisp.push(["safe", true])

  const isChatBtn = true
  const isChatHideShow = true

  if (isChatBtn) {
    const open = () => {
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])
    }

    const close = () => {
      $crisp.push(["do", "chat:hide"])
    }

    close()
    $crisp.push(["on", "chat:closed", function() {
      close()
    }])

    window.chatBtnFn = () => {
      $crisp.is("chat:visible") ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        $crisp.push(["do", "chat:hide"])
      },
      show: () => {
        $crisp.push(["do", "chat:show"])
      }
    }
  }
})()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = '9b641e64578348fe885b51aaf45ea8e5';
  var gaud_map_key = '9bba5cdce903fe14f85ffa4e71b7710e';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-20},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>